# 分布式事务

## 2PC
1. 两阶段提交：强一致性分布式事务，分为prepare、commit两阶段，存在协调者与参与者，协调者负责发送prepare请求与commit或者rollback请求给参与者，协调事务的执行或者回滚；一旦全部参与者在prepare阶段返回OK，协调者就会发送commit给全部参与者；  
2. 要点：prepare阶段，每个参与者会本地执行事务（但不提交），锁定相关资源，利用锁与MVCC保证隔离性，同时写入undo、redo日志，只有当协调者发送commit时才提交事务，否则一直阻塞；mysql XA事务即2PC分布式事务，利用bin log与redo log实现XA事务；  
3. 异常点1：prepare阶段存在节点延迟或者OK丢失或者节点宕机掉线等 -> 协调者只会在全部参与者返回OK后，才会发送commit，协调者不存在超时，会一直重试发送prepare给异常参与者直到成功返回响应，参与者不存在超时，一直锁定资源（部分数据库可能支持超时，比如支持协调者超时rollback，但不支持参与者超时释放或者提交）；   
4. 异常点2：prepare阶段全部参与者返回OK，但commit阶段，只有部分参与者接收到commit指令，部分参与者宕机或者分区导致无法提交 -> 协调者会一直重试发送commit给故障参与者，直到成功；当重试次数过多或者参与者永久宕机等，需要人工介入恢复一致性；当参与者宕机恢复时，可通过日志以及请求协调者恢复数据与事务的提交；  
5. 局限点：协调者单点故障；参与者宕机或者脑裂会导致资源占用；

## 3PC
1. 三阶段提交：在2PC基础上引入超时机制，分为CanCommit、PreCommit、DoCommit三阶段，CanCommit不锁定资源，PreCommit执行事务锁定资源写入日志（但不提交事务），DoCommit提交事务；  
2. 要点：理论上是对2PC的改进，保证DoCommit前全部节点状态一致，并且当参与者或者协调者故障时，参与者超时自动提交；在PreCommit及之前，但凡超时或者有参与者返回fail，回滚分布式事务；
3. 异常点1：若参与者发送了PreCommit响应后发生网络问题（如掉线或延迟），可能导致协调者因超时发送Abort指令，而参与者因超时自动提交事务，此时就会出现不一致；或者出现分区，导致在precommit回复响应阶段，丢失命令，也会出现不一致（比如部分参与者返回了fail或者响应超时，协调者发送abort命令，但丢失，部分返回ok的参与者可能超时自动提交了）；  
4. 解决方式：一般在3PC中引入额外的分布式协议或者采用补偿事务；
5. 引入分布式协议（比如raft）替代协调者：CanCommit阶段所有参与者检查本地资源可用性，返回Yes或No；PreCommit阶段任一节点发起提案，提案内容为“提交事务”，通过分布式协议确保多数节点接受提案，DoCommit阶段若提案通过，所有参与者提交事务，否则回滚。
6. 引入分布式协议（比如raft）增强协调者：




        

## MQ事务




## TCC




## 补偿



